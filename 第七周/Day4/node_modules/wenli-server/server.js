#!/usr/bin/env node
var http = require('http');
var mime = require('mime');
var fs = require('fs');
var path = require('path');
var prot = process.argv[2]? parseInt(process.argv[2]) : 8090;
var html = '<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><title>Title</title></head><body><div></div></body></html>';
http.createServer(function (req, res) {
    fs.exists(req.url.slice(1), function (exists) {
        if (req.url == '/') { // 如果是根目录
            var str = '<ul>';
            fs.readdir('.', function (err, files) {
                files.forEach(function (file) {
                    str += '<li><a href= ' +  file + '>' + file + '</a></li>'
                });
                str += '</ul>';
                    htmls = html.replace('<div></div>', str);
                    res.end(htmls);
            })
        } else { // 其他访问路径
            if (exists) {
                fs.stat(req.url.slice(1), function (err, stat) {
                    if (stat.isFile()) { // 如果是文件
                        res.setHeader('Content-Type', mime.lookup(req.url) + ';charset=utf-8');
                        fs.readFile(req.url.slice(1), function (err, data) {
                            res.end(data);
                        })
                    } else { // 如果是目录
                        fs.readdir(req.url.slice(1), function (err, subfile) {
                            var str = '<ul>';
                            subfile.forEach(function (file) {
                                str += '<li><a href= '+ path.join(req.url, file) + '>' +file+ '</a></li>'
                            });
                            str += '</ul>';
                            htmls = html.replace('<div></div>', str);
                            res.end(htmls);
                        })
                    }
                });

            } else {
                res.end('文件找不到')
            }
        }

    });

}).listen(prot, function () {
    console.log('监听'+ prot+'端口');
});